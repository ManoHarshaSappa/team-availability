<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Team Availability</title>
<style>
  :root{ --bg:#0b0c10; --card:#121318; --ink:#e9eef6; --muted:#8a8f98;
         --accent:#6aa7ff; --danger:#ff6b6b; --grid:#ffffff; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
  .container{max-width:1120px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 12px 0;font-size:22px}
  .card{background:var(--card);border:1px solid #1a1c22;border-radius:14px;box-shadow:0 1px 0 #000,0 30px 80px rgba(0,0,0,.35)}

  /* Top switches */
  .switcher{display:flex;gap:10px;padding:12px;border-bottom:1px solid #1a1c22}
  .switcher button{background:#10233c;border:1px solid #153258;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .switcher button.active{box-shadow:0 0 0 3px rgba(106,167,255,.12)}

  /* Form bars (only one visible at a time) */
  .bar{display:flex;gap:12px;align-items:center;padding:12px;border-bottom:1px solid #1a1c22}
  .group{display:flex;gap:8px;align-items:center}
  label{font-size:12px;color:var(--muted)}
  select,button{background:#0f1116;color:var(--ink);border:1px solid #2a2e35;border-radius:10px;padding:8px 10px}
  select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(106,167,255,.12)}
  .danger{background:#3a1214;border-color:#5e1b20}
  .ok{background:#103623;border-color:#174f32}
  .ghost{background:transparent;border-color:#2a2e35}
  [hidden]{display:none !important}

  .legend{display:flex;gap:16px;font-size:12px;padding:8px 12px;color:var(--muted)}
  .chip{display:inline-flex;gap:8px;align-items:center}
  .chip .dot{width:16px;height:16px;border:1px solid var(--grid);border-radius:4px;position:relative}
  .chip .dot.busy::after{content:"✕";position:absolute;inset:0;display:grid;place-items:center;color:var(--danger);font-weight:700;font-size:12px}

  /* Weekly grid */
  .grid-wrap{overflow:auto}
  .grid{display:grid;grid-template-columns:88px repeat(7,1fr);background:#0b0d12;border-top:1px solid var(--grid);border-left:1px solid var(--grid)}
  .col-head,.time,.cell{border-right:1px solid var(--grid);border-bottom:1px solid var(--grid)}
  .col-head{position:sticky;top:0;z-index:2;background:#141722;text-align:center;padding:8px 6px;font-weight:600}
  .time{background:#0f1116;color:var(--muted);padding:6px 8px;position:sticky;left:0;z-index:1;font-variant-numeric:tabular-nums}
  .cell{height:30px;background:transparent;border:none}
  .cell.busy::after{content:"✕";color:var(--danger);font-weight:800;display:grid;place-items:center}
  .cell:hover{background:rgba(106,167,255,.08)}
  .cell.busy:hover{background:rgba(255,107,107,.10)}

  /* See-by-day matrix */
  #dayMatrix{overflow:auto;border:1px solid #2a2e35;border-radius:12px;margin:12px}
  table.matrix{border-collapse:collapse;width:100%;background:#0b0d12}
  .matrix th,.matrix td{border:1px solid #2a2e35;padding:6px 8px}
  .matrix th{background:#141722;position:sticky;top:0}
  .matrix .timeCol{position:sticky;left:0;background:#0f1116;color:var(--muted)}
  .x{color:var(--danger);font-weight:800;text-align:center}

  .footer{padding:10px 12px;display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px;border-top:1px solid #1a1c22}

  @media (max-width:720px){
    .col-head{font-size:12px;padding:6px 4px;top:92px}
    .time{font-size:12px}
    .cell{height:36px}
  }
</style>
</head>
<body>
<div class="container">
  <h1>Team Availability</h1>
  <div class="card">

    <!-- TWO OPTIONS ONLY -->
    <div class="switcher">
      <button id="btnFill" class="active">Fill Availability</button>
      <button id="btnSee">See by Day</button>
    </div>

    <!-- FILL AVAILABILITY -->
    <div id="barFill" class="bar">
      <div class="group">
        <label for="user">Name</label>
        <select id="user"></select>
      </div>
      <div class="group">
        <label for="edit">Edit</label>
        <select id="edit">
          <option value="mark">Mark busy</option>
          <option value="clear">Mark free</option>
        </select>
      </div>
      <button id="clearMine" class="danger">Clear my availability</button>
    </div>

    <div id="legendFill" class="legend">
      <span class="chip"><span class="dot"></span> Free (leave empty)</span>
      <span class="chip"><span class="dot busy"></span> Busy (red ✕)</span>
      <span>Autosaves to GitHub. Everyone sees updates.</span>
    </div>

    <div id="gridWrap" class="grid-wrap">
      <div id="grid" class="grid"><!-- built by JS --></div>
    </div>

    <!-- SEE BY DAY -->
    <div id="barSee" class="bar" hidden>
      <div class="group">
        <label for="viewDay">Day</label>
        <select id="viewDay"></select>
      </div>
      <span id="dayHint" class="ghost" style="padding:8px 10px;border-radius:10px;border:1px solid #2a2e35;color:var(--muted)">
        Matrix of all 5 people for the selected day
      </span>
    </div>

    <div id="dayMatrix" hidden></div>

    <div class="footer">
      <span id="status">Loading…</span>
      <span>Tip: choose your name, click cells.</span>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const API_URL = "/api/availability"; // same Vercel project
const DEFAULT_USERS = ["Harsha","Sarmad","Sneha Deshpande","Vinay","Bhavishya"];
const DAYS = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const START=0, END=24*60, STEP=30, SLOTS=Math.floor((END-START)/STEP);

/* ====== helpers ====== */
const $ = id => document.getElementById(id);
function minutesToLabel(m){ const hh=Math.floor(m/60)%24, mm=m%60, am=hh>=12?"PM":"AM", h=((hh+11)%12)+1; return `${h}:${mm.toString().padStart(2,"0")} ${am}`; }
function setStatus(t){ $("status").textContent=t; }

/* ====== state ====== */
let state={users:{},log:[]};
const blankWeek=()=>Object.fromEntries(Array.from({length:7},(_,d)=>[`d${d}`,Array.from({length:SLOTS},()=>0)]));
function ensureUser(n){ if(!state.users[n]) state.users[n]=blankWeek(); }
function ensureDropdowns(){
  if(!$("user").options.length){ DEFAULT_USERS.forEach(n=>{ const o=document.createElement("option"); o.value=n; o.textContent=n; $("user").appendChild(o); }); }
  if(!$("viewDay").options.length){ DAYS.forEach((n,i)=>{ const o=document.createElement("option"); o.value=i; o.textContent=n; $("viewDay").appendChild(o); }); }
}

/* ====== grid ====== */
const grid=$("grid");
function colHead(t){ const el=document.createElement("div"); el.className="col-head"; el.textContent=t; return el; }
function timeCell(t){ const el=document.createElement("div"); el.className="time"; el.textContent=t; return el; }
function buildGrid(){
  grid.innerHTML=""; grid.appendChild(colHead("Time")); DAYS.forEach(d=>grid.appendChild(colHead(d)));
  for(let i=0;i<SLOTS;i++){
    grid.appendChild(timeCell(minutesToLabel(START+i*STEP)));
    for(let d=0;d<7;d++){
      const b=document.createElement("button");
      b.className="cell"; b.dataset.day=d; b.dataset.slot=i;
      b.addEventListener("click", onCellClick);
      grid.appendChild(b);
    }
  }
}
function renderForUser(name){
  ensureUser(name);
  document.querySelectorAll(".cell").forEach(b=>b.classList.remove("busy"));
  for(let d=0; d<7; d++){
    const arr=state.users[name][`d${d}`]||[];
    for(let i=0;i<SLOTS;i++) if(arr[i]===1){
      const b=document.querySelector(`.cell[data-day="${d}"][data-slot="${i}"]`);
      if(b) b.classList.add("busy");
    }
  }
}

/* ====== live sync (GitHub via API) ====== */
async function pullLatest(silent=false){
  try{
    const latest = await fetch(API_URL, {cache:"no-store"}).then(r=>r.ok?r.json():null);
    if(!latest) throw new Error("bad response");
    // Merge: keep all users from server; add missing local users (if any)
    state = {
      users: {...latest.users},
      log: Array.isArray(latest.log) ? latest.log : []
    };
    ensureUser($("user").value);
    renderForUser($("user").value);
    if(!silent){ setStatus("Up to date."); }
    if(currentMode==="see") renderDayMatrix();
  }catch(e){
    if(!silent){ setStatus("Failed to pull latest."); }
  }
}

let saveQueue = Promise.resolve();
async function pushLatest(commitUser){
  // Always fetch fresh first, merge our user, then post to avoid overwrites
  saveQueue = saveQueue.then(async ()=>{
    try{
      setStatus("Saving…");
      const latest = await fetch(API_URL, {cache:"no-store"}).then(r=>r.ok?r.json():{users:{},log:[]});
      const merged = { users: {...latest.users, ...state.users}, log: [
        { ts:new Date().toISOString(), user: commitUser||$("user").value, reason:"update" },
        ...latest.log
      ].slice(0,5000) };
      const r = await fetch(API_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(merged)
      });
      if(!r.ok){ setStatus("Save failed."); return; }
      const out = await r.json();
      setStatus(`Saved. Commit ${out.commit||"ok"}.`);
    }catch(e){
      setStatus("Save failed (network).");
    }
  });
  return saveQueue;
}

/* ====== interactions ====== */
function onCellClick(e){
  if(currentMode!=="fill") return;
  const name=$("user").value; ensureUser(name);
  const d=+e.currentTarget.dataset.day, i=+e.currentTarget.dataset.slot;
  const v = $("edit").value==="mark" ? 1 : 0;
  if(state.users[name][`d${d}`][i]!==v){
    state.users[name][`d${d}`][i]=v;
    e.currentTarget.classList.toggle("busy", v===1);
    pushLatest(name);
  }
}

/* ====== see-by-day matrix ====== */
function renderDayMatrix(){
  const dayIdx=+$("viewDay").value||0;
  const container=$("dayMatrix");
  const cols=["Time",...DEFAULT_USERS];
  let html=`<table class="matrix"><thead><tr>${cols.map(c=>`<th>${c}</th>`).join("")}</tr></thead><tbody>`;
  for(let i=0;i<SLOTS;i++){
    const t=minutesToLabel(START+i*STEP);
    const cells=DEFAULT_USERS.map(u=>{
      const a=(state.users[u]?.[`d${dayIdx}`]||[]);
      return `<td class="${a[i]===1?'x':''}">${a[i]===1?'✕':''}</td>`;
    }).join("");
    html+=`<tr><td class="timeCol">${t}</td>${cells}</tr>`;
  }
  html+=`</tbody></table>`;
  container.innerHTML=html;
}

/* ====== Clear mine ====== */
$("clearMine").addEventListener("click", async ()=>{
  const who=$("user").value;
  if(!confirm(`Clear ALL availability for ${who}? This updates GitHub for everyone.`)) return;
  ensureUser(who);
  for(let d=0; d<7; d++){ state.users[who][`d${d}`]=Array.from({length:SLOTS},()=>0); }
  renderForUser(who);
  await pushLatest(who);
  if(currentMode==="see") renderDayMatrix();
});

/* ====== Switcher ====== */
let currentMode="fill";
function goFill(){
  currentMode="fill";
  $("btnFill").classList.add("active"); $("btnSee").classList.remove("active");
  $("barFill").hidden=false; $("legendFill").hidden=false; $("gridWrap").hidden=false;
  $("barSee").hidden=true;  $("dayMatrix").hidden=true;
}
function goSee(){
  currentMode="see";
  $("btnSee").classList.add("active"); $("btnFill").classList.remove("active");
  $("barSee").hidden=false; $("dayMatrix").hidden=false;
  $("barFill").hidden=true; $("legendFill").hidden=true; $("gridWrap").hidden=true;
  renderDayMatrix();
}
$("btnFill").addEventListener("click", goFill);
$("btnSee").addEventListener("click",  goSee);

/* ====== hooks ====== */
$("user").addEventListener("change", ()=>{ ensureUser($("user").value); renderForUser($("user").value); });
$("viewDay").addEventListener("change", renderDayMatrix);

/* ====== boot ====== */
buildGrid(); ensureDropdowns();
$("user").value = DEFAULT_USERS[0];
$("viewDay").value = "0";
pullLatest(); // initial load from GitHub (shared)
setInterval(()=>pullLatest(true), 10000); // live refresh every 10s (silent)
</script>
</body>
</html>
