<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Team Availability</title>
<style>
  :root{ --bg:#0b0c10; --card:#121318; --ink:#e9eef6; --muted:#8a8f98;
         --accent:#6aa7ff; --danger:#ff6b6b; --grid:#ffffff; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
  .container{max-width:1120px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 12px 0;font-size:22px}
  .card{background:var(--card);border:1px solid #1a1c22;border-radius:14px;box-shadow:0 1px 0 #000,0 30px 80px rgba(0,0,0,.35)}
  .toolbar{position:sticky;top:0;z-index:5;display:flex;flex-wrap:wrap;gap:10px;padding:12px;border-bottom:1px solid #1a1c22}
  .bar{display:flex;gap:10px;align-items:center}
  .group{display:flex;gap:8px;align-items:center}
  label{font-size:12px;color:var(--muted)}
  select,button{background:#0f1116;color:var(--ink);border:1px solid #2a2e35;border-radius:10px;padding:8px 10px}
  select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(106,167,255,.12)}
  .tab{background:#10233c;border-color:#153258}
  .danger{background:#3a1214;border-color:#5e1b20}
  .ok{background:#103623;border-color:#174f32}
  .ghost{background:transparent;border-color:#2a2e35}
  .legend{display:flex;gap:16px;font-size:12px;padding:8px 12px;color:var(--muted)}
    .chip{display:inline-flex;gap:8px;align-items:center}
    .chip .dot{width:16px;height:16px;border:1px solid var(--grid);border-radius:4px;position:relative}
    .chip .dot.busy::after{content:"✕";position:absolute;inset:0;display:grid;place-items:center;color:var(--danger);font-weight:700;font-size:12px}
  .grid-wrap{overflow:auto}
  .grid{display:grid;grid-template-columns:88px repeat(7,1fr);background:#0b0d12;border-top:1px solid var(--grid);border-left:1px solid var(--grid)}
  .col-head,.time,.cell{border-right:1px solid var(--grid);border-bottom:1px solid var(--grid)}
  .col-head{position:sticky;top:0;z-index:2;background:#141722;text-align:center;padding:8px 6px;font-weight:600}
  .time{background:#0f1116;color:var(--muted);padding:6px 8px;position:sticky;left:0;z-index:1;font-variant-numeric:tabular-nums}
  .cell{height:30px;background:transparent;border:none}
  .cell.busy::after{content:"✕";color:var(--danger);font-weight:800;display:grid;place-items:center}
  .cell:hover{background:rgba(106,167,255,.08)}
  .cell.busy:hover{background:rgba(255,107,107,.10)}
  .footer{padding:10px 12px;display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px;border-top:1px solid #1a1c22}

  /* Day matrix */
  #dayPanel{display:none;padding:12px;border-top:1px dashed #2a2e35}
  #dayMatrix{overflow:auto;border:1px solid #2a2e35;border-radius:12px}
  table.matrix{border-collapse:collapse;width:100%;background:#0b0d12}
  .matrix th,.matrix td{border:1px solid #2a2e35;padding:6px 8px}
  .matrix th{background:#141722;position:sticky;top:0}
  .matrix .timeCol{position:sticky;left:0;background:#0f1116;color:var(--muted)}
  .x{color:var(--danger);font-weight:800;text-align:center}

  [hidden]{display:none !important}

  @media (max-width:720px){
    .col-head{font-size:12px;padding:6px 4px;top:58px}
    .time{font-size:12px}
    .cell{height:36px}
  }
</style>
</head>
<body>
<div class="container">
  <h1>Team Availability</h1>

  <div class="card">
    <div class="toolbar">
      <div class="bar">
        <button id="tabFill" class="tab">Fill availability</button>
        <button id="tabSee"  class="tab">See by day</button>
      </div>

      <!-- FILL BAR (only Name, Edit, Clear all) -->
      <div id="barFill" class="bar">
        <div class="group">
          <label for="user">Name</label>
          <select id="user"></select>
        </div>
        <div class="group">
          <label for="edit">Edit</label>
          <select id="edit">
            <option value="mark">Mark busy</option>
            <option value="clear">Mark free</option>
          </select>
        </div>
        <button id="clearAll" class="danger">Clear all (this browser)</button>
        <button id="sync" class="ok" hidden>Sync to GitHub</button>
      </div>

      <!-- SEE-BY-DAY BAR (only Day) -->
      <div id="barSee" class="bar" hidden>
        <div class="group">
          <label for="viewDay">Day</label>
          <select id="viewDay"></select>
        </div>
        <span id="dayLabel" class="ghost" style="padding:8px 10px;border-radius:10px;color:var(--muted);border:1px solid #2a2e35">Matrix view</span>
      </div>
    </div>

    <div class="legend">
      <span class="chip"><span class="dot"></span> Free (leave empty)</span>
      <span class="chip"><span class="dot busy"></span> Busy (red ✕)</span>
      <span>Local save is instant. Click <b>Sync to GitHub</b> if you unhide it.</span>
    </div>

    <div class="grid-wrap">
      <div id="grid" class="grid"><!-- built by JS --></div>
    </div>

    <div id="dayPanel">
      <div class="status-inline">Matrix for <strong id="matrixDayName"></strong></div>
      <div id="dayMatrix"></div>
    </div>

    <div class="footer">
      <span id="status">Ready.</span>
      <span>Tip: choose your name, click cells.</span>
    </div>
  </div>
</div>

<script>
/* ============== CONFIG ============== */
const API_URL = "/api/availability"; // same project on Vercel
const DEFAULT_USERS = ["Harsha","Sarmad","Sneha Deshpande","Vinay","Bhavishya"];
const DAYS = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const START_MIN=0, END_MIN=24*60, STEP=30, SLOTS=Math.floor((END_MIN-START_MIN)/STEP);
const LS_KEY="teamAvailabilityData:v2";

/* ============== HELPERS ============== */
const $ = id => document.getElementById(id);
function minutesToLabel(m){ const hh=Math.floor(m/60)%24, mm=m%60, am=hh>=12?"PM":"AM", h=((hh+11)%12)+1; return `${h}:${mm.toString().padStart(2,"0")} ${am}`; }
function setStatus(t){ $("status").textContent=t; }

/* ============== STATE ============== */
let state={users:{},log:[]};
const blankWeek = () => Object.fromEntries(Array.from({length:7},(_,d)=>[`d${d}`,Array.from({length:SLOTS},()=>0)]) );
function ensureUser(name){ if(!state.users[name]) state.users[name]=blankWeek(); }
function ensureDefaults(){
  DEFAULT_USERS.forEach(ensureUser);
  // name dropdown
  const u=$("user"); if(!u.options.length){ DEFAULT_USERS.forEach(n=>{ const o=document.createElement("option"); o.value=n; o.textContent=n; u.appendChild(o); }); }
  // day dropdown
  const d=$("viewDay"); if(!d.options.length){ DAYS.forEach((n,i)=>{ const o=document.createElement("option"); o.value=i; o.textContent=n; d.appendChild(o); }); }
}

/* ============== GRID ============== */
const grid=$("grid");
function colHead(t){ const el=document.createElement("div"); el.className="col-head"; el.textContent=t; return el; }
function timeCell(t){ const el=document.createElement("div"); el.className="time"; el.textContent=t; return el; }
function buildGrid(){
  grid.innerHTML=""; grid.appendChild(colHead("Time")); DAYS.forEach(d=>grid.appendChild(colHead(d)));
  for(let i=0;i<SLOTS;i++){
    grid.appendChild(timeCell(minutesToLabel(START_MIN+i*STEP)));
    for(let d=0; d<7; d++){
      const b=document.createElement("button");
      b.className="cell"; b.dataset.day=d; b.dataset.slot=i;
      b.addEventListener("click", onCellClick);
      grid.appendChild(b);
    }
  }
}
function renderForUser(name){
  ensureUser(name);
  document.querySelectorAll(".cell").forEach(b=>b.classList.remove("busy"));
  for(let d=0; d<7; d++){
    const arr=state.users[name][`d${d}`]||[];
    for(let i=0;i<SLOTS;i++) if(arr[i]===1){
      const b=document.querySelector(`.cell[data-day="${d}"][data-slot="${i}"]`);
      if(b) b.classList.add("busy");
    }
  }
}
function onCellClick(e){
  if(currentTab!=="fill") return; // disabled in See view
  const name=$("user").value; ensureUser(name);
  const d=+e.currentTarget.dataset.day, i=+e.currentTarget.dataset.slot;
  const val = $("edit").value==="mark" ? 1 : 0;
  if(state.users[name][`d${d}`][i]!==val){
    state.users[name][`d${d}`][i]=val;
    e.currentTarget.classList.toggle("busy", val===1);
    saveLocal();
    logChange(name,d,i,val);
  }
}

/* ============== LOCAL + GITHUB ============== */
function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function loadLocal(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw){ const j=JSON.parse(raw); state.users=j.users||{}; state.log=j.log||[]; } }catch{} }
function logChange(user,day,slot,value){ state.log.unshift({ts:new Date().toISOString(),user,reason:"update",changes:[{day,slot,value}]}); state.log=state.log.slice(0,5000); }

async function syncToGitHub(){
  setStatus("Syncing to GitHub…");
  try{
    const latest=await fetch(API_URL).then(r=>r.ok?r.json():{users:{},log:[]});
    const merged={users:{...latest.users, ...state.users}, log: state.log};
    const r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(merged)});
    if(!r.ok){ setStatus("Sync failed"); return; }
    const out=await r.json(); setStatus("Synced. Commit: "+(out.commit||"ok"));
  }catch{ setStatus("Sync failed – network/API"); }
}

/* ============== SEE-BY-DAY MATRIX ============== */
function renderDayMatrix(){
  const dayIdx=+$("viewDay").value||0;
  $("matrixDayName").textContent=DAYS[dayIdx];
  $("dayLabel").textContent=`• ${DAYS[dayIdx]}`;
  const container=$("dayMatrix");
  const cols=["Time", ...DEFAULT_USERS];
  let html=`<table class="matrix"><thead><tr>${cols.map(c=>`<th>${c}</th>`).join("")}</tr></thead><tbody>`;
  for(let i=0;i<SLOTS;i++){
    const t=minutesToLabel(START_MIN+i*STEP);
    const cells=DEFAULT_USERS.map(u=>{ const a=(state.users[u]?.[`d${dayIdx}`]||[]); return `<td class="${a[i]===1?'x':''}">${a[i]===1?'✕':''}</td>`; }).join("");
    html+=`<tr><td class="timeCol">${t}</td>${cells}</tr>`;
  }
  html+=`</tbody></table>`;
  container.innerHTML=html;
}

/* ============== CLEAR ALL (this browser) ============== */
$("clearAll").addEventListener("click", ()=>{
  if(!confirm("Clear all data in THIS browser? (Team data on GitHub is unchanged until you sync)")) return;
  state={users:{},log:[]}; ensureDefaults(); renderForUser($("user").value); saveLocal(); setStatus("Cleared (local).");
});

/* ============== TABS ============== */
let currentTab="fill";
function show(tab){
  currentTab=tab;
  $("barFill").hidden = tab!=="fill";
  $("barSee").hidden  = tab!=="see";
  $("dayPanel").style.display = tab==="see" ? "block" : "none";
}
$("tabFill").addEventListener("click", ()=>show("fill"));
$("tabSee").addEventListener("click",  ()=>{ show("see"); renderDayMatrix(); });

/* ============== HOOKS ============== */
$("user").addEventListener("change", e=>{ ensureUser(e.target.value); renderForUser(e.target.value); });
$("viewDay").addEventListener("change", renderDayMatrix);
$("sync").addEventListener("click", syncToGitHub);

// boot
buildGrid(); loadLocal(); ensureDefaults();
$("user").value = DEFAULT_USERS[0];
renderForUser(DEFAULT_USERS[0]);
$("viewDay").value="0"; // Sunday default
setStatus("Ready.");
</script>
</body>
</html>
